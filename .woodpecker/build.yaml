when:
  - event: [push, tag, deployment]
    branch: main

steps:
  - name: frontend-build
    image: node:20
    commands:
      - corepack enable
      - corepack prepare pnpm@latest --activate
      - pnpm config set store-dir .pnpm-store
      - cd web
      - pnpm install
      - pnpm build

  # - name: backend-audit
  #   image: golang:latest
  #   commands:
  #     - go fmt ./...
  #     - go vet ./...
  #     - go mod tidy
  #     - go mod verify
  #     - go test ./...

  - name: container-build
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: ghcr.io/${CI_REPO_OWNER}/${CI_REPO_NAME}
      platforms: linux/amd64, linux/arm64
      username: ${CI_REPO_OWNER}
      password:
        from_secret: ghcr_password
