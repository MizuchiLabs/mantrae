when:
  - event: [push, tag, deployment, manual]
    branch: main

steps:
  - name: frontend-build
    image: node:20
    commands:
      - corepack enable
      - corepack prepare pnpm@latest --activate
      - pnpm config set store-dir .pnpm-store
      - cd web
      - pnpm install
      - pnpm build

  - name: backend-build
    image: golang:latest
    commands:
      - go fmt ./...
      - go vet ./...
      - go mod tidy
      - go mod verify
      - go test ./...
      - |
        for arch in amd64 arm64; do \
          CGO_ENABLED=0 GOOS=linux GOARCH=$arch go build \
          -ldflags "-s -w -X github.com/MizuchiLabs/mantrae/pkg/util.Version=${CI_COMMIT_TAG} \
                          -X github.com/MizuchiLabs/mantrae/pkg/util.BuildDate=${CI_PIPELINE_CREATED} \
                          -X github.com/MizuchiLabs/mantrae/pkg/util.Commit=${CI_COMMIT_SHA}" \
          -o mantrae-linux-$arch main.go; \
        done

  - name: container-build
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: ghcr.io/${CI_REPO_OWNER,,}/${CI_REPO_NAME}
      registry: ghcr.io
      platforms: linux/amd64, linux/arm64
      username: ${CI_REPO_OWNER}
      auto_tag: true
      auto_labels: true
      password:
        from_secret: gh_token

  - name: deploy-docs
    image: node:20
    commands:
      - git config --global user.name "${CI_COMMIT_AUTHOR}"
      - git config --global user.email "${CI_COMMIT_AUTHOR_EMAIL}"
      - echo "machine github.com login ${CI_COMMIT_AUTHOR} password ${GITHUB_TOKEN}" > ~/.netrc
      - corepack enable
      - corepack prepare pnpm@latest --activate
      - pnpm config set store-dir .pnpm-store
      - cd docs
      - pnpm install
      - pnpm deploy
    environment:
      GIT_USER: ${CI_COMMIT_AUTHOR}
      GITHUB_TOKEN:
        from_secret: gh_token

  - name: release
    image: goreleaser/goreleaser
    commands:
      - goreleaser release --clean --skip=validate
    environment:
      GITHUB_TOKEN:
        from_secret: gh_token
    when:
      event: tag
